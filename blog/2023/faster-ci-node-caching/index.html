<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>node dependency caching | Nicholas Tolhurst</title> <meta name="author" content="Nicholas Tolhurst"> <meta name="description" content="Cache Node.JS dependencies between pipeline runs. "> <meta name="keywords" content="jekyll, jekyll-theme, tech-blog, portfolio-website, devops"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/zenburn.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%A4%93&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://www.nicholastolhurst.com/blog/2023/faster-ci-node-caching/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/monokai.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Nicholas </span>Tolhurst</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">node dependency caching</h1> <p class="post-meta">March 13, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/azure"> <i class="fas fa-hashtag fa-sm"></i> Azure</a>   <a href="/blog/tag/devops"> <i class="fas fa-hashtag fa-sm"></i> DevOps</a>   <a href="/blog/tag/pipelines"> <i class="fas fa-hashtag fa-sm"></i> Pipelines</a>   <a href="/blog/tag/cicd"> <i class="fas fa-hashtag fa-sm"></i> CICD</a>     ·   <a href="/blog/category/azure-devops"> <i class="fas fa-tag fa-sm"></i> azure-devops</a>   </p> </header> <article class="post-content"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/npm-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/npm-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/npm-1400.webp"></source> <img src="/assets/img/npm.png" class="img-fluid no-border hero rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="what-is-caching">What is caching?</h3> <p>In short, caching is a transient high-speed data storage layer that stores data for faster retrieval than from the source.</p> <p>For #AzureDevOps, this enables us to store our project’s dependencies on the pipeline’s cache layer and then retrieve them on subsequent runs. This additional task can make subsequent runs much faster.</p> <p>In some cases, caching may not be economical, as the retrieval from a cache may take longer than downloading from the origin.</p> <h3 id="how-to-use-the-cache2-task">How to use the <code class="language-plaintext highlighter-rouge">Cache@2</code> task?</h3> <p>The most basic implementation of <code class="language-plaintext highlighter-rouge">Cache@2</code> requires a <code class="language-plaintext highlighter-rouge">cache key</code> and a <code class="language-plaintext highlighter-rouge">path</code>. The <code class="language-plaintext highlighter-rouge">key</code> is used to generate a dynamic hash that determines whether or not there is a valid cache stored. The <code class="language-plaintext highlighter-rouge">path</code> is the directory you want to store and retrieve.</p> <p>The cache key consists of strings, file paths, or file patterns separated by a pipe character (<code class="language-plaintext highlighter-rouge">|</code>).</p> <p>Use strings as identifiers, a good example would be a tool name, tool version, or OS version. Think, “if I change my OS version, do my dependencies change?”. If so, having the OS version referenced in the cache key is correct.</p> <p>A file path (file pattern) produces a hash based on the file (collection of files), resulting in a unique key each time the contents of this file (these files) change. Think, “What changes only when I update my dependencies?”. Use that file as a part of the cache key.</p> <p>For example, we will look at the pipeline’s NPM dependencies. In the pipeline, we require a specific Node version. This node version matches the installed tools of our developers. In this case, we are not concerned with the version of the tool. We will start our key with simply the tool <code class="language-plaintext highlighter-rouge">node</code>. Though not an immediate requirement, we likely want to build the application on Windows and Linux operating systems. Therefore, the cache key can extend to <code class="language-plaintext highlighter-rouge">node | "$(Agent.Os)"</code>. Finally, to determine whether or not the dependencies have changed, we will target a single <code class="language-plaintext highlighter-rouge">package-lock.json</code> file. We know the <code class="language-plaintext highlighter-rouge">package-lock.json</code> only updates when a Node dependency has changed. Our final cache key is <code class="language-plaintext highlighter-rouge">node | "$(Agent.OS)" | **/package-lock.json</code>.</p> <blockquote> <p>Gotcha: Keys with a period (<code class="language-plaintext highlighter-rouge">.</code>) in them are considered file paths. To avoid this interpretation, wrap those keys in double quotes (<code class="language-plaintext highlighter-rouge">"</code>), as we have the <code class="language-plaintext highlighter-rouge">"$(Agent.OS)"</code> segment in the example.</p> </blockquote> <p>The <code class="language-plaintext highlighter-rouge">path</code> parameter value is the location of the Node dependencies. In our case, this is <code class="language-plaintext highlighter-rouge">$(Build.SourcesDirectory)\node_modules</code>.</p> <p>Having <code class="language-plaintext highlighter-rouge">node_modules</code> pull from the cache is considerably quicker than downloading them using <code class="language-plaintext highlighter-rouge">npm</code>. Moreover, installing <code class="language-plaintext highlighter-rouge">node_modules</code> when they already exist is quicker than installing them into an empty directory. However, do we need to install them if we have retrieved them from the cache?</p> <p>By setting the task parameter <code class="language-plaintext highlighter-rouge">cacheHitVar</code>, a build-scoped variable is available to us and can be used as a condition in subsequent tasks, allowing us to avoid the unnecessary re-install of <code class="language-plaintext highlighter-rouge">node_modules</code> if they already exist on disk. Therefore, we will set <code class="language-plaintext highlighter-rouge">cacheHitVar</code> to <code class="language-plaintext highlighter-rouge">NODE_CACHE_HIT</code> and add the condition <code class="language-plaintext highlighter-rouge">ne(variables.NODE_CACHE_HIT, 'true')</code> to the step that installs our dependencies.</p> <h4 id="example">Example</h4> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Cache@2</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Cache node_modules Directory</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">"$(Agent.OS)"</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">$(Build.SourcesDirectory)\package-lock.json'</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">$(Build.SourcesDirectory)\node_modules</span>
    <span class="na">cacheHitVar</span><span class="pi">:</span> <span class="s">NODE_CACHE_HIT</span>

<span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">Npm@1</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Install node_modules</span>
  <span class="na">inputs</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s1">'</span><span class="s">install'</span>
    <span class="na">workingDir</span><span class="pi">:</span> <span class="s">$(Build.SourcesDirectory)</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="s">ne(variables.NODE_CACHE_HIT, 'true')</span></code></pre></figure> <p>What took approximately 2 minutes and 40 seconds now takes 35 seconds on each subsequent run after a dependency change. In this example, we can apply this to 2 different Node applications, saving 3 minutes and 40 seconds.</p> <p>There we have it! Our Node dependencies are cached, and a considerable saving from merely a few extra lines of code.</p> <p>What could be next? Caching NuGet packages?</p> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"nicktolhurst/nicktolhurst.github.io","data-repo-id":"R_kgDOJIRzlQ","data-category":"Comments","data-category-id":"DIC_kwDOJIRzlc4CUzsX","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Nicholas Tolhurst. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>